<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Arkanoid</title>
</head>

<body>
  <script src="keys.js"></script>
  <script src="engine.js"></script>
  <script src="graph.js"></script>
  <script src="player.js"></script>

  <canvas id="canvas" width="640" height="480"></canvas>

  <script type="text/javascript">
    init();

    var grid = {
      // Массив элементов в виде сетки
      nodes: [],
      // Добавляет один елемент в массив nodes
      add: function(x, y, w, h, c) {
        var tmp = new _Enemy(x, y, w, h, c);
        this.nodes.push(tmp);
      },

      //Генерация елементов
      generate: function(count, w, h, color) {
        var dW = 5,
          dX = dW,
          dY = dW;
        dCountX = Math.ceil(width / (w + dW)) - 1;
        dAllw = Math.ceil((width - (w + dW) * dCountX) / 2);
        dY = dAllw;
        for (var i = 0; i < count; i++) {
          for (var j = 0; j < dCountX; j++) {
            if (j == 0) {
              dX += Math.ceil(dAllw - dW / 2);
            }
            this.add(dX, dY, w, h, color);
            dX += w + dW;
          }
          dY += h + dW;
          dX = dW;
        }
      },
      // Удаляет один елемент при попададии в него при игре
      destroy: function(id) {
        this.nodes.splice(id, 1);
      },

      draw: function() {
        for (en in this.nodes) {
          this.nodes[en].draw();
        }
      }
    };
    // Строительный элемент (прототип)
    var _Enemy = function(x, y, w, h, color) {
      this.x = x;
      this.y = y;
      this.width = w;
      this.height = h;
      this.color = color;
    };

    _Enemy.prototype.draw = function() {
      drawRect(this.x, this.y, this.width, this.height, this.color);
    };
    // Обьект шар
    var ball = {
      speed: 1,
      dx: 1,
      dy: -1,
      color: 'blue',
      x: 0,
      y: 0,
      radius: 5,
      // Отрисовка игрового шара
      draw: function() {
        drawCircle(this.x, this.y, this.radius, this.color);
      },
      //Инициализация шара
      init: function (x, y, radius, color) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
      },
      // Движение шара
      move: function() {
        this.x += this.speed * this.dx;
        this.y += this.speed * this.dy;
      },
      // Обработка столкновения шара
      collision: function() {
        for(var i in grid.nodes) {
          var enemy = grid.nodes[i];
          if(isCollision(this.x - this.radius, this.y - this.radius, this.radius*2, this.radius*2
            , enemy.x, enemy.y, enemy.width, enemy.height)) {
              this.dy *= -1;
              grid.destroy(i);
          }
        }
        if(isCollision(this.x - this.radius, this.y - this.radius, this.radius*2, this.radius*2
          , player.x, player.y, player.width, player.height)) {
            this.dy *= -1;
        }
        if(this.x + this.radius >= width) {
          this.dx *= -1;
        }
        if(this.x - this.radius <= 0) {
          this.dx = 1;
        }
      },


    };

    grid.generate(5, 60, 30, 'red');
    ball.init(player.x + Math.ceil(player.width / 2), player.y - 5, 5, 'blue');

    var game = function() {
      fillAll('#acdae6');
      grid.draw();

      ball.collision();
      ball.move();
      ball.draw();

      player.move();
      player.draw();

    };

    startGame(game);
  </script>


</body>

</html>
